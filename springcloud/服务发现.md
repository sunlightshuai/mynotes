# springCloud 服务发现
## 服务发现组件对比。此对比来自老师。[老师的git](https://github.com/mercyblitz)
### Eureka，一致性【AP】，一致性协议【HTTP定时轮询】，通讯方式【HTTP REST】，更新机制【服务器之间+服务器和客户端】 ，使用规模【20K~30K实例】，性能问题【简单的更新机制、复杂设计、规模较大时GC频繁】
### Zookeeper，一致性【CP】，一致性协议【ZAB】，通讯方式【自定义】，更新机制【ZK Watch】 ，使用规模【10K~20K实例】，性能问题【扩容麻烦、规模较大时GC频繁】

### Spring Cloud Discovery ZK 服务器

注意：client端和服务端的版本问题

```java
	<dependency>
    	<groupId>org.springframework.cloud</groupId>
    	<artifactId>spring-cloud-starter-zookeeper-all</artifactId>
   	 	<exclusions>
        	<exclusion>
            	<groupId>org.apache.zookeeper</groupId>
            	<artifactId>zookeeper</artifactId>
       	 	</exclusion>
    	</exclusions>
	</dependency>
	<dependency>
    	<groupId>org.apache.zookeeper</groupId>
    	<artifactId>zookeeper</artifactId>
    	<version>3.4.12</version>
    	<exclusions>
        	<exclusion>
            	<groupId>org.slf4j</groupId>
            	<artifactId>slf4j-log4j12</artifactId>
        	</exclusion>
    	</exclusions>
	</dependency>
```

启动本地的zk


```java

	@SpringBootApplication
	@EnableDiscoveryClient
	public class App {
    	public static void main( String[] args ){
        	SpringApplication.run(App.class,args);
    	}
	}
```

```java

	@Target({ElementType.TYPE})
	@Retention(RetentionPolicy.RUNTIME)
	@Documented
	@Inherited
	@Import({EnableDiscoveryClientImportSelector.class})
	public @interface EnableDiscoveryClient {
	    boolean autoRegister() default true;// 默认为true
	}

```
`EnableDiscoveryClientImportSelector`当autoRegister为true时加载`AutoServiceRegistrationConfiguration`

```java

	@Configuration
	@EnableConfigurationProperties({AutoServiceRegistrationProperties.class})
	@ConditionalOnProperty(
	    value = {"spring.cloud.service-registry.auto-registration.enabled"},
	    matchIfMissing = true
	)
	public class AutoServiceRegistrationConfiguration {
	    public AutoServiceRegistrationConfiguration() {
	    }
	}

```


`AutoServiceRegistrationConfiguration`此类有

```java

	@Configuration
	@Import({AutoServiceRegistrationConfiguration.class})
	@ConditionalOnProperty(
	    value = {"spring.cloud.service-registry.auto-registration.enabled"},
	    matchIfMissing = true
	)
	public class AutoServiceRegistrationAutoConfiguration
```

`AutoServiceRegistrationAutoConfiguration`使用的是

```java

	@Configuration
	@ConditionalOnMissingBean(
	    type = {"org.springframework.cloud.zookeeper.discovery.ZookeeperLifecycle"}
	)
	@ConditionalOnZookeeperDiscoveryEnabled
	@ConditionalOnProperty(
	    value = {"spring.cloud.service-registry.auto-registration.enabled"},
	    matchIfMissing = true
	)
	@AutoConfigureAfter({ZookeeperServiceRegistryAutoConfiguration.class})
	@AutoConfigureBefore({AutoServiceRegistrationAutoConfiguration.class, ZookeeperDiscoveryAutoConfiguration.class})
	public class ZookeeperAutoServiceRegistrationAutoConfiguration

```

关于Zookeeper的加载可以查看`ZookeeperAutoServiceRegistrationAutoConfiguration`相关配置。
# Java体系结构

Java体系结构包括四个独立但相互关联的技术点：
* Java程序语言
* Java Class文件格式
* Java应用接口
* Java虚拟机

用Java语言编写源代码，把Java原文件编译成Java Class文件，然后在Java 虚拟机中运行Class文件。在写源代码时，使用Java提供的API中来实现相关的逻辑操作。

## Java虚拟机

Java虚拟机的主要任务是装载class文件并且执行其中的字节码。

Java虚拟机采用什么方式，什么样的结构，如何加载Class文件并执行其中的字节码？

### 何种方式——执行引擎

不同的Java虚拟机，执行引擎实现可能不同。

* 一次性解释字节码

  最简单的方式

* 及时编译器

  相对较快，但是也比较消耗内存。第一次被执行的字节码会编译成本地机器代码，编译出的本地机器代码会被缓存，当方法被调用的时候可以重用。

* 自适应优化器

  虚拟机开始的时候解释字节码，但是会监视运行中程序的活动，并且记录使用频繁的代码段。程序运行的时候，虚拟机只把那些活动最频繁的代码编译成本地代码，其他的代码由于使用并不频繁，继续保留为字节码。



### 何种结构——类装载器

一个Java应用程序粗略可以分为两种`启动（bootstrap）`类装载器和`用户定义`类装载器。也可以分为启动类装载器，系统类装载器和扩展类装载器。

每一个类被装载的时候，Java虚拟机都监视这个类，判断是被启动类装载器还是被用户定义类装载器装载。当被装载的类引用另外一个类时，虚拟机就会使用装载得一个类的类状态器装载被引用的类。

### 何种形式——“双亲”加载

类装载器请求另一个装载器来装载的过程，被称为“双亲”类装载器。除启动类装载器以外的每一个类装载器，都有一个“双亲”类装载器，在某特定的类装载器试图以常用方式来装载类型以前，默认将这个任务委派给他的双亲来装载这个类型。双亲在一次请求他的双亲来装载这个类型，这个委派的过程一直向上继续，直到达到启动类装载器，如果一个类装载器的双亲类装载器有能力来装载这个类型，则这个类装载器返回该类型。否则，这个类装载自己来装载这个类型。

## class文件

Java Class文件为Java程序提供独立于底层主机平台的二进制形式的服务。

## Java API

Java API是运行库的集合，提供一套访问主机系统资源的标准方法。

## Java语言设计

Java语言特性：

* 面向对象
* 多线程
* 结构化错误处理
* 垃圾收集
* 动态连接
* 动态扩展

# Java安全体系

## 基本沙箱（总的逻辑命名)

组成Java沙箱的基本逻辑单元

* 类装载器

* class文件检验器

* 内置于Java虚拟机安全特性

* 安全管理器级API

## 类装载器

（1）防止恶意篡改

使用命名空间。由包，类名，以及对应的访问修饰符。

（2）守护可信任类库的边界

不同的类装载器装载可靠或者不可靠的包。由包与包之间的访问规则，“双亲”委派类装载器。

（3）将代码归入某类，该类确定了代码可以进行哪些操作



## class文件检验器

class文件检验器保证装载的class文件内部结构的正确性。

class文件检验器进行四趟独立扫描来完成操作。第一趟扫描是在类被装载时进行的。第二趟和第三趟是在连接过程中进行的，第四趟扫描是在进行动态连接的过程中解析符号引用时进行的。

### 第一趟：class文件的结构检查

每一段将被当做类型导入的字节序列，class文件检验器都会确认是否符合Java Class文件的基本结构。

每个class文件必须以四个同样的字节开始：魔数0xCAFEBABE。检验器还必须确认在class文件中声明的主版本号和次版本号，这个版本号必须在这个Java虚拟机实现可以支持的范围内。

在第一趟扫描中，class文件检验器检验确认这个class文件没有被删节，尾部没有附带其他字节。确保这些字节序列是正确的，符合Java Class文件的固定格式。

### 第二趟：语义检查

查看每个组成部分，确保是Java定义的所属数据类型，包括，方法描述符，返回类型，有参，无参，参数的个数，这些被存储的字符，是否符合Java 语义。

### 第三趟：字节码验证

Java虚拟机对类的方法进行数据流分析。

Java方法由操作码的单字节指令组成的序列，每一个操作后都跟着一个或多个操作数。操作数用于在Java虚拟机执行操作码指令时提供所需的额外的数据字节码，依次执行每个字节码，构成了Java虚拟机的线程。每个线程有不同的Java栈，这个栈由不同的栈帧构成。每一个方法调用将获得一个本线程内的栈帧，栈帧实际是一个内存执行逻辑片段，其中存储着局部变量和计算的中间结果。其中，存储中间结果的部分被称为该方法的操作数栈。

字节码检验器要进行大量的检查，以确保采用任何路径在字节码流中都能得到一个确定的操作码指令，确保操作数栈总是包含正确的数值以及正确的类型。保证局部变量在赋予合适的值以前不能被访问，类的字段中必须被赋予正确类型的值，类的方法被调用时总是传递正确数值和类型的参数。字节码检验器还必须保证每一个操作码都是合法的。

### 第四趟：符号引用的验证

Class文件检验器的引用验证，是动态连接过程的一部分。

首先动态连接是一个将符号引用解析为直接引用的过程。当Java虚拟机执行字节码时，这个操作码第一次使用一个指向另一个类的符号引用，那么虚拟机就需要解释这个引用。在解析时，需要查找被引用的类，将符号引用解释为直接引用。

Java虚拟机解析一个符号引用时，Class文件检验器确保这个引用时合法的。

## Java 虚拟机中内置的安全特性

* 类型安全引用转换

* 结构化的内存访问

* 自动垃圾收集

* 数据边界检查

* 空引用检查

## 安全管理器和Java API

  Java 安全模型的前三个组成部分——类装载器、Class文件检验器以及Java中内置的安全特性，一起达到一个目的：保证Java虚拟机运行时，实例的内在完整性，使之不会被恶意篡改。安全管理和Java API，主要用于保护虚拟机的外部资源不被虚拟机内运行的恶意代码侵犯。

安全管理器定义了沙箱的外部边界。也允许程序建立自定义的安全策略。Java API进行操作是，会向安全管理请求许可，从而强制执行安全策略。

## 代码签名/认证

Java API供了签名和认证的功能来支持Java 的安全模型。包含密钥的生成以及管理。

数字签名过程的首先是一个单向散列计算。例如JAR文件，计算大量输入就是组成这个JAR文件内容的字节流，这个单向散列计算只给出散列的情况下，这个散列不能包含足够的输入信息，因此不能从散列重新生成原输入。

## 保护域

类加载器将类型装入Java虚拟机是，为每个类型指派一个保护域，保护域定义了代码所有权限。

##  访问控制器

AccessController提供了一个默认的安全策略执行机制，用来检查不安全的操作是否被允许。

# 类的生命周期

装载 =》连接（验证=》准备=》解析）=》初始化